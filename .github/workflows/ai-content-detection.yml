name: 'AI Content Detection'
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to analyze'
        required: true
        type: number
      confidence_threshold:
        description: 'Confidence threshold percentage (0-100)'
        default: '80'
        type: string
      pr_label:
        description: 'Label to add to PR if AI detected (leave empty to skip)'
        default: 'ai-generated'
        type: string
      skip_users:
        description:
          'Comma-separated list of users to skip (e.g., dependabot,renovate)'
        default: ''
        type: string
      fail_on_detection:
        description: 'Fail workflow if AI content detected'
        default: true
        type: boolean
      dry_run:
        description: 'Test mode: analyze but do not post/label/fail'
        default: true
        type: boolean
      custom_prompt:
        description: 'Custom analysis prompt (leave empty for default)'
        default: ''
        type: string
      diff_max_chars:
        description: 'Maximum diff size in characters'
        default: '20000'
        type: string
  pull_request_target:

jobs:
  analyze:
    name: 'Analyze PR'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: otelbot-token
        with:
          app-id: ${{ vars.OTELBOT_APP_ID }}
          private-key: ${{ secrets.OTELBOT_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Install script dependencies
        working-directory: ./scripts/ai-content-detection
        run: npm install

      - name: Run AI detection analysis
        working-directory: ./scripts/ai-content-detection
        env:
          GH_TOKEN: ${{ steps.otelbot-token.outputs.token }}
          PR_NUMBER:
            ${{ github.event.inputs.pr_number ||
            github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CONFIDENCE_THRESHOLD:
            ${{ github.event.inputs.confidence_threshold || '80' }}
          PR_LABEL: ${{ github.event.inputs.pr_label || 'ai-generated' }}
          SKIP_USERS: ${{ github.event.inputs.skip_users || '' }}
          FAIL_ON_DETECTION:
            ${{ (github.event_name == 'workflow_dispatch' &&
            github.event.inputs.fail_on_detection == true) && 'true' || 'false'
            }}
          DRY_RUN:
            ${{ (github.event_name == 'workflow_dispatch' &&
            github.event.inputs.dry_run == true) && 'true' || 'true' }}
          CUSTOM_PROMPT: ${{ github.event.inputs.custom_prompt || '' }}
          DIFF_MAX_CHARS: ${{ github.event.inputs.diff_max_chars || '20000' }}
        run: node analyze.js
