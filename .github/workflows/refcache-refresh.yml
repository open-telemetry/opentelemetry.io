name: Refcache refresh
# cSpell:ignore otelbot

# Creates (or updates) the PR that refreshes a number of the oldest refcache
# entries. We say "the PR", because there can be at most one such PR at a time.
# We refresh by first pruning the oldest N entries, then running the link
# checker to update the refcache. N is set via the workflow_dispatch input.
#
# If the PR branch already exists, then by default we only rebase from `main`.
# To force further pruning of the existing PR branch, invoke with
# `prune_more_in_same_PR` is true.
#
on:
  schedule:
    - cron: '33 9 * * *' # daily at 9:33 UTC
  workflow_dispatch:
    inputs:
      number_of_entries_to_refresh:
        description: Number of (oldest) refcache entries to refresh.
        default: 128
        type: number
      prune_more_in_same_PR:
        description: Prune more entries from existing PR branch (if any).
        default: false
        type: boolean
      rebase_from_main:
        description: Rebase from main instead of merging.
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  refcache-refresh:
    runs-on: ubuntu-latest
    env:
      BRANCH: otelbot/refcache-refresh
      IS_NEW_BRANCH: 'false'
      REFRESH_COUNT: ${{ github.event.inputs.number_of_entries_to_refresh }}
      PRUNE_MORE: ${{ github.event.inputs.prune_more_in_same_PR }}
      REBASE_FROM_MAIN: ${{ github.event.inputs.rebase_from_main }}
    steps:
      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: otelbot-token
        with:
          # the higher privileged docs token is needed to push commits to an existing PR
          app-id: ${{ vars.OTELBOT_DOCS_APP_ID }}
          private-key: ${{ secrets.OTELBOT_DOCS_PRIVATE_KEY }}

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          # Needed to trigger workflows when pushing new commits to an existing PR
          token: ${{ steps.otelbot-token.outputs.token }}

      - name: Validate inputs
        run: |
          if [[ ! "$REFRESH_COUNT" =~ ^[0-9]+$ ]] || [[ "$REFRESH_COUNT" -lt 1 ]]; then
            echo "Error: REFRESH_COUNT must be a positive integer, got: $REFRESH_COUNT"
            exit 1
          fi

      - name: Checkout or create branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git ls-remote --exit-code --heads origin $BRANCH; then
            git checkout -b $BRANCH origin/main
            git push -u origin $BRANCH
            echo "IS_NEW_BRANCH=true" >> $GITHUB_ENV
            echo "PRUNE_N=$REFRESH_COUNT" >> $GITHUB_ENV
          else
            git checkout $BRANCH
            echo "PRUNE_N=\"1 --list\"" >> $GITHUB_ENV

            PR_URL=$(gh pr view --json url --jq '.url')
            echo "PR_URL=$PR_URL"
          fi

      - name: Use CLA approved github bot
        run: |
          git config user.name otelbot
          git config user.email 197425009+otelbot@users.noreply.github.com

      - name: Merge (or rebase) from main
        run: |
          merge_or_rebase="merge"
          push_args=""
          if [ "$REBASE_FROM_MAIN" == "true" ]; then
            merge_or_rebase="rebase"
            push_args="--force-with-lease"
          fi
          previous=$(git rev-parse HEAD)
          git fetch origin
          git $merge_or_rebase origin/main
          if [ "$(git rev-parse HEAD)" != "$previous" ]; then
            git push $push_args origin $BRANCH
          fi

      - uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc

      - run: npm install --omit=optional

      - name: Prune refcache
        if: ${{ env.PRUNE_MORE == 'true' || env.IS_NEW_BRANCH == 'true' }}
        run: |
          echo "List the oldest entry"
          npm run _refcache:prune -- --list -n 1
          echo "Pruning $PRUNE_N oldest refcache entries"
          npm run _refcache:prune -- -n $PRUNE_N

      - name: List oldest entry
        run: npm run _refcache:prune -- --list -n 1

      - name: Update refcache
        run: |
          # Ignore link-check failures so we can still commit refcache updates
          npm run fix:refcache || true
          # Don't prune 4xx entries so we can further process them via the PR
          # npm run _refcache:prune

          git add -A

          if ! git diff-index --quiet --cached HEAD; then
            git commit -am "Update refcache"
            git push
          fi

      - name: Create PR if needed
        env:
          GH_TOKEN: ${{ steps.otelbot-token.outputs.token }}
        run: |
          prs=$(gh pr list --state open --head $BRANCH)
          echo "Existing PR(s):"
          echo "${prs:-none}"
          if [[ -n "$prs" ]]; then
            echo "PR already exists, so we're done."
            exit 0
          fi

          if gh pr create --title "Refresh refcache" \
              --body "Refreshes the oldest ${{ env.REFRESH_COUNT }} refcache entries." \
              --draft;
          then
            PR_URL=$(gh pr view --json url --jq '.url')
            printf "PR created: %s\n" "$PR_URL"
          else
            echo "Failed to create PR - likely no commits to create PR from"
            exit 0  # Don't fail the workflow, just skip PR creation
          fi
