{{ $dest := .Destination -}}
{{ $u := urls.Parse $dest -}}

{{/* Note: $u.IsAbs is true if $dest has a scheme (e.g., "http:") */ -}}

{{ if and
    (hasPrefix $.PageInner.RelPermalink "/docs/specs")
    (not $u.IsAbs)
    (not (hasPrefix $dest "#"))
-}}

  {{ $path := replaceRE `\bREADME\.md\b` "_index.md" $u.Path -}}
  {{ $href := $dest -}}
  {{ with or
    ($.PageInner.GetPage $path)
    ($.PageInner.Resources.Get $path)
    (resources.Get $path)
  -}}
    {{ $href = .RelPermalink -}}
    {{ with $u.RawQuery -}}{{ $href = printf "%s?%s" $href . -}}{{ end -}}
    {{ with $u.Fragment -}}{{ $href = printf "%s#%s" $href . -}}{{ end -}}
  {{ else -}}

    {{/* We can't find a page for $dest.

    - If $dest refers to a Markdown file, issue a warning, since we should be
      able to find it.

    - Otherwise, it's a path to a resource file. Most often, $path is absolute,
      and the resource is inside a page bundle. Hugo's global or page Resource.Get
      can't handle that, so just ignore the issue. If there is a real problem, and
      the path is invalid, it will be caught by the link checker.

    - If the resource path starts with `./`, adjust it to be `../` to match
      GitHub's relative paths, provide the page this link is in is not an index
      page.

    */ -}}

    {{ if hasSuffix $path ".md" -}}
      {{ warnf "File %s: cannot resolve spec link reference '%s' (%s)" .Page.File.Filename $dest $path -}}
    {{ else -}}
      {{ if and
            (hasPrefix $href "./")
            (not (hasSuffix .Page.File.Filename "_index.md"))
            (not (hasSuffix .Page.File.Filename "README.md"))
      -}}
        {{ $href = add "." $href -}}
      {{ end -}}
      {{ warnidf "spec-resource-not-found" "File %s: cannot resolve spec link reference '%s' (%s)" .Page.File.Filename $dest $href -}}
    {{ end -}}
  {{ end -}}
  {{ $dest = $href -}}

{{ else if hasPrefix $dest "/" -}}

  {{/*
    Based on Hugo's default render-link hook:
    https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/_markup/render-link.html
  */ -}}

  {{- $href := $u.String -}}
  {{- if hasPrefix $href "#" -}}
    {{/* Do nothing: leave $href as is */ -}}
  {{- else if and $href (not $u.IsAbs) -}}
    {{- $path := strings.TrimPrefix "./" $u.Path -}}
    {{- with or
      ($.PageInner.GetPage $path)
      ($.PageInner.Resources.Get $path)
      (resources.Get $path)
    -}}
      {{- $href = .RelPermalink -}}
      {{- with $u.RawQuery -}}
        {{- $href = printf "%s?%s" $href . -}}
      {{- end -}}
      {{- with $u.Fragment -}}
        {{- $href = printf "%s#%s" $href . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{ $dest = $href -}}

  {{/* Backwards compatibility with the previous version of this render-link hook */ -}}
  {{ if hasSuffix $dest (add .Destination "/") -}}
    {{ $dest = strings.TrimSuffix "/" $dest -}}
  {{ else if eq .Destination (add $dest "#") -}}
    {{ $dest = .Destination -}}
  {{ else if hasSuffix $dest (add $u.Path "/#" $u.Fragment) -}}
    {{ $dest = replace $dest "/#" "#" -}}
  {{ end -}}

{{ else if and $u.IsAbs (eq $u.Scheme "http")
    (not ($u.Query.Has "disable_http_check"))
    (not (findRE `\blocalhost\b|^127\.0` $u.Host))
-}}

  {{/*
    TODO: drop the temporary allowance of various hosts such as publicsuffix.org once
    https://github.com/open-telemetry/opentelemetry.io/issues/6409
    is fully resolved.
  */ -}}
  {{ if findRE `^(publicsuffix.org|docs.oasis|unitsofmeasure|connect.build)` $u.Host -}}
    {{/* Do nothing until semconv fixes land. */ -}}
  {{ else -}}
    {{ warnf "%s: use 'https' for external URL '%s', or add query parameter '?disable_http_check'" .Page.File.Path $dest -}}
  {{ end -}}
{{ end -}}

{{/* General link-render processing */ -}}

{{ $isExternal := hasPrefix $dest "http" -}}
{{ if $isExternal -}}
  {{ $matches := findRESubmatch `^https?://(?:www\.)?opentelemetry.io(/?.*)$` $dest -}}
  {{ $otelIoPath := index (index $matches 0) 1 | default "/" -}}
  {{ if $matches -}}
    {{ warnf "%s: use a local path '%s' instead of external URL '%s' for reference to site-local page"
        .Page.File.Path $otelIoPath $dest -}}
  {{ else if or
    (findRE "^https://github.com/open-telemetry/opentelemetry-specification/(blob|tree)/main/specification/\\w" $dest)
    (findRE "^https://github.com/open-telemetry/opentelemetry-proto/(blob|tree)/main/docs/specification" $dest)
    (findRE "^https://github.com/open-telemetry/semantic-conventions/(blob|tree)/main/docs" $dest)
    -}}
    {{ warnf "%s: use a local path, not an external URL, for the following reference to a local specification page: %s"
    .Page.File.Path $dest -}}
  {{ end -}}
{{ end -}}

{{/* Until Hugo supports hook params (https://github.com/gohugoio/hugo/issues/6670), we'll inspect .Text. */ -}}

<a href="{{ $dest | safeURL }}"
  {{- with .Title}} title="{{ . }}"{{ end -}}
  {{- if $isExternal }} target="_blank" rel="noopener"
    {{- $noExternalIcon := in .Text "hk-no-external-icon" -}}
    {{ if not $noExternalIcon }} class="external-link"{{ end -}}
  {{ end -}}
>
  {{- .Text | safeHTML -}}
</a>

{{- /* Trim trailing whitespace */ -}}
